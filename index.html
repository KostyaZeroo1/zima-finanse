<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Мои Финансы • Зима 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { --accent: #00ffff; }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:'Segoe UI',sans-serif;
            background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
            color:#e0f7fa;
            min-height:100vh;
            overflow-x:hidden;
            position:relative;
        }

        /* === НАСТОЯЩАЯ НОВОГОДНЯЯ ГИРЛЯНДА === */
        .garland-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 140px;
            pointer-events: none;
            z-index: 998;
            overflow: hidden;
        }
        .garland-wire {
            position: absolute;
            top: 65px;
            left: -5%;
            width: 110%;
            height: 5px;
            background: linear-gradient(to right, transparent, #0f330f 15%, #0f330f 85%, transparent);
            border-radius: 3px;
            box-shadow: 0 0 15px rgba(0,255,0,0.4);
            transform: rotate(1.5deg);
        }
        .garland-lights {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 140px;
        }
        .garland-light {
            position: absolute;
            width: 20px; height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ffffaa, #ffaa00 60%, #cc4400);
            box-shadow: 0 0 25px 8px #ffaa00, 0 0 50px 15px #ff6600, inset 0 0 12px rgba(255,255,150,0.9);
            animation: glow 2.5s infinite ease-in-out;
            transform: translateX(-50%);
        }
        .garland-light:nth-child(4n+1){background:radial-gradient(circle at 35% 35%,#aaffff,#0088ff 60%,#0044cc);box-shadow:0 0 25px 8px #0088ff,0 0 50px 15px #00ccff;}
        .garland-light:nth-child(4n+2){background:radial-gradient(circle at 35% 35%,#ffaaff,#ff0088 60%,#cc0044);box-shadow:0 0 25px 8px #ff0088,0 0 50px 15px #ff66aa;}
        .garland-light:nth-child(4n+3){background:radial-gradient(circle at 35% 35%,#aaffaa,#00ff00 60%,#008800);box-shadow:0 0 25px 8px #00ff00,0 0 50px 15px #88ff88;}
        @keyframes glow{
            0%,100%{opacity:0.6;transform:translateX(-50%) scale(1) translateY(0);}
            50%    {opacity:1;  transform:translateX(-50%) scale(1.2) translateY(-5px);}
        }

        /* Снег */
        .snow{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}

        header{text-align:center;padding:100px 20px 20px;background:rgba(0,0,0,0.4);position:relative;z-index:20;}
        h1{font-size:3.8rem;text-shadow:0 0 30px #00ffff,0 0 60px #00ffff;}
        nav{background:rgba(0,0,0,0.5);padding:15px 0;position:sticky;top:0;z-index:30;}
        nav a{color:#fff;text-decoration:none;margin:0 20px;padding:10px 20px;border-radius:12px;transition:0.3s;}
        nav a:hover{background:var(--accent);color:#000;}

        .container{max-width:1100px;margin:40px auto;padding:0 20px;}
        .card{background:rgba(255,255,255,0.12);backdrop-filter:blur(12px);border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 15px 35px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);}
        input,button,select{padding:14px;margin:8px 0;border:none;border-radius:12px;font-size:1rem;width:100%;}
        input,select{background:rgba(255,255,255,0.2);color:white;}
        button{background:var(--accent);color:#000;font-weight:bold;cursor:pointer;transition:0.3s;}
        button:hover{background:#00bfff;transform:scale(1.05);}
        .progress-container{width:100%;background:rgba(0,0,0,0.4);height:45px;border-radius:25px;overflow:hidden;margin:25px 0;}
        .progress{height:100%;background:linear-gradient(90deg,#00ff00,#00ffff);transition:width 1s ease;display:flex;align-items:center;justify-content:center;color:#000;font-weight:bold;font-size:1.4rem;}
        table{width:100%;border-collapse:collapse;margin-top:20px;}
        th,td{padding:15px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.2);}
        th{background:rgba(0,255,255,0.2);}
        .delete-btn{background:#ff0040;color:white;padding:8px 14px;border-radius:8px;cursor:pointer;}

        .currency-btn{padding:12px 20px;margin:0 8px;border-radius:12px;background:rgba(255,255,255,0.15);border:2px solid transparent;cursor:pointer;transition:0.3s;}
        .currency-btn.active{border-color:var(--accent);background:rgba(0,255,255,0.2);transform:scale(1.1);}
        .music-btn{position:fixed;bottom:20px;right:20px;background:rgba(0,255,255,0.3);border-radius:50%;width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;z-index:1000;box-shadow:0 0 20px #0ff;}
        .page{display:none;}
        #home{display:block;}
    </style>
</head>
<body>

<!-- КРАСИВАЯ ГИРЛЯНДА -->
<div class="garland-container">
    <div class="garland-wire"></div>
    <div class="garland-lights" id="garlandLights"></div>
</div>

<!-- Снег -->
<div class="snow"></div>

<header>
    <h1>Мои Финансы 2025</h1>
    <p>Зимний трекер с реальными курсами ЦБ</p>
</header>

<nav>
    <a href="#home" onclick="showPage('home')">Главная</a>
    <a href="#income" onclick="showPage('income')">Доходы</a>
    <a href="#expense" onclick="showPage('expense')">Расходы</a>
    <a href="#goal" onclick="showPage('goal')">Цель</a>
    <a href="#stats" onclick="showPage('stats')">Статистика</a>
</nav>

<!-- Выбор валюты -->
<div class="container">
    <div class="card" style="text-align:center;">
        <h3>Основная валюта (автопересчёт)</h3>
        <p>Все суммы пересчитываются по курсу ЦБ при смене</p>
        <div style="margin:20px 0;">
            <button class="currency-btn active" data-cur="RUB">RUB</button>
            <button class="currency-btn" data-cur="USD">$ USD</button>
            <button class="currency-btn" data-cur="EUR">EUR</button>
        </div>
        <small id="rate-info">Загрузка курсов...</small>
    </div>
</div>

<div class="container">
    <!-- Главная -->
    <div id="home" class="page">
        <div class="card">
            <h2>Добро пожаловать!</h2>
            <div class="goal" id="mainGoal">Цель не установлена</div>
            <div class="progress-container"><div class="progress" id="mainProgress">0%</div></div>
            <p style="text-align:center;font-size:1.8rem;margin:30px 0;">
                Баланс: <b id="balance">0</b> <span id="currencySymbol">₽</span><br><br>
                Отложено: <b id="saved">0</b> <span id="currencySymbol2">₽</span>
            </p>
        </div>
    </div>

    <!-- Доходы -->
    <div id="income" class="page">
        <div class="card">
            <h2>Добавить доход</h2>
            <input type="text" id="incomeDesc" placeholder="Источник">
            <input type="number" id="incomeAmount" placeholder="Сумма" step="0.01">
            <button onclick="addIncome()">+ Добавить</button>
            <h3 style="margin-top:30px">История</h3>
            <table id="incomeTable"><tr><th>Описание</th><th>Сумма</th><th></th></tr></table>
        </div>
    </div>

    <!-- Расходы -->
    <div id="expense" class="page">
        <div class="card">
            <h2>Добавить расход</h2>
            <input type="text" id="expenseDesc" placeholder="На что">
            <input type="number" id="expenseAmount" placeholder="Сумма" step="0.01">
            <button onclick="addExpense()">− Добавить</button>
            <h3 style="margin-top:30px">История</h3>
            <table id="expenseTable"><tr><th>Описание</th><th>Сумма</th><th></th></tr></table>
        </div>
    </div>

    <!-- Цель -->
    <div id="goal" class="page">
        <div class="card">
            <h2>Финансовая цель</h2>
            <input type="text" id="goalName" placeholder="Название цели">
            <input type="number" id="goalAmount" placeholder="Сколько нужно" step="0.01">
            <button onclick="setGoal()">Установить</button>
            <div id="currentGoal" style="margin-top:30px;font-size:1.3rem;"></div>
        </div>
    </div>

    <!-- Статистика -->
    <div id="stats" class="page">
        <div class="card">
            <h2>Статистика</h2>
            <div id="statsInfo">Загрузка...</div>
        </div>
    </div>
</div>

<!-- Музыка -->
<div class="music-btn" onclick="toggleMusic()">Play</div>
<audio id="xmasMusic" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/11/28/audio_5c7d7e9a1e.mp3" type="audio/mpeg">
</audio>

<script>
// === Гирлянда ===
function createRealGarland() {
    const container = document.getElementById('garlandLights');
    container.innerHTML = '';
    const count = Math.floor(window.innerWidth / 70) + 12;
    const baseY = 65;
    const sag = 18;
    for (let i = 0; i < count; i++) {
        const light = document.createElement('div');
        light.className = 'garland-light';
        const x = (i / (count - 1)) * 100;
        const yOffset = Math.sin((i / count) * Math.PI) * sag;
        light.style.left = x + '%';
        light.style.top = (baseY + yOffset) + 'px';
        light.style.animationDelay = Math.random() * 2 + 's';
        container.appendChild(light);
    }
}
createRealGarland();
window.addEventListener('resize', createRealGarland);

// === Снег ===
setInterval(()=>{const s=document.createElement('div');s.style.cssText=`position:absolute;width:${Math.random()*4+2}px;height:${s.style.width};background:white;border-radius:50%;opacity:${Math.random()*0.5+0.5};left:${Math.random()*100}vw;top:-10px;animation:fall ${Math.random()*10+10}s linear forwards`;document.querySelector('.snow').appendChild(s);setTimeout(()=>s.remove(),20000);},100);
document.head.appendChild(Object.assign(document.createElement('style'),{innerHTML:'@keyframes fall{to{transform:translateY(110vh) rotate(720deg);}}'}));

// === Музыка ===
let music=document.getElementById('xmasMusic');
function toggleMusic(){
    if(music.paused){music.play();document.querySelector('.music-btn').innerHTML='Stop';}
    else{music.pause();document.querySelector('.music-btn').innerHTML='Play';}
}

// === Курсы + Валюта ===
let displayCurrency = localStorage.getItem("displayCurrency") || "RUB";
let rates = {RUB:1, USD:95, EUR:105};

async function loadRates(){
    try{
        const r=await fetch("https://www.cbr-xml-daily.ru/daily_json.js");
        const d=await r.json();
        rates.USD=d.Valute.USD.Value;
        rates.EUR=d.Valute.EUR.Value;
        rates.RUB=1;
        document.getElementById("rate-info").innerHTML=`Курс ЦБ: 1$ = ${rates.USD.toFixed(2)}₽ • 1€ = ${rates.EUR.toFixed(2)}₽ • ${new Date().toLocaleDateString("ru")}`;
    }catch{ document.getElementById("rate-info").textContent="Офлайн-режим (курсы приблизительные)"; }
    renderAll();
}
loadRates(); setInterval(loadRates,12*60*60*1000);

function setDisplayCurrency(c){
    displayCurrency=c;
    localStorage.setItem("displayCurrency",c);
    document.querySelectorAll(".currency-btn").forEach(b=>b.classList.toggle("active",b.dataset.cur===c));
    renderAll();
}
document.querySelectorAll(".currency-btn").forEach(b=>b.onclick=()=>setDisplayCurrency(b.dataset.cur));
document.querySelector(`[data-cur="${displayCurrency}"]`).classList.add("active");

function getSymbol(){return displayCurrency==="RUB"?"₽":displayCurrency==="USD"?"$":"€";}
function toRUB(a){return Math.round(a * rates[displayCurrency] * 100)/100;}
function fromRUB(a){return Math.round((a / rates[displayCurrency]) * 100)/100;}
function fmt(n){return Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g," ");}

// === Финансы (хранится в RUB) ===
let rawIncomes = JSON.parse(localStorage.getItem("ri")||"[]");
let rawExpenses = JSON.parse(localStorage.getItem("re")||"[]");
let rawGoal = JSON.parse(localStorage.getItem("rg")||null);

function save(){localStorage.setItem("ri",JSON.stringify(rawIncomes));localStorage.setItem("re",JSON.stringify(rawExpenses));localStorage.setItem("rg",JSON.stringify(rawGoal));}

function calc(){
    const inc = rawIncomes.reduce((s,i)=>s+i.a,0);
    const exp = rawExpenses.reduce((s,e)=>s+e.a,0);
    const bal = inc - exp;
    const prog = rawGoal ? Math.min(100, bal / rawGoal.a * 100) : 0;
    return {bal, prog, inc, exp, goalAmt: rawGoal?rawGoal.a:0};
}

function renderAll(){
    const c = calc();
    const sym = getSymbol();
    document.getElementById("balance").textContent = fmt(fromRUB(c.bal));
    document.getElementById("saved").textContent = fmt(fromRUB(rawGoal?c.bal:0));
    document.getElementById("currencySymbol").textContent = sym;
    document.getElementById("currencySymbol2").textContent = sym;
    document.getElementById("mainProgress").style.width = c.prog + "%";
    document.getElementById("mainProgress").textContent = c.prog.toFixed(1)+"%";

    if(rawGoal){
        document.getElementById("mainGoal").textContent = `${rawGoal.n} — нужно ${fmt(fromRUB(rawGoal.a))} ${sym}`;
        document.getElementById("currentGoal").innerHTML = `<strong>${rawGoal.n}</strong><br>Нужно: ${fmt(fromRUB(rawGoal.a))} ${sym}<br>Накоплено: ${fmt(fromRUB(c.bal))} ${sym} (${c.prog.toFixed(1)}%)`;
    }else{
        document.getElementById("mainGoal").textContent="Цель не установлена";
        document.getElementById("currentGoal").innerHTML="Установите цель на вкладке «Цель»";
    }

    // Таблицы
    const it = document.getElementById("incomeTable"); it.innerHTML="<tr><th>Описание</th><th>Сумма</th><th></th></tr>";
    rawIncomes.forEach((i,idx)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i.d}</td><td>${fmt(fromRUB(i.a))} ${sym}</td><td><button class="delete-btn" onclick="delInc(${idx})">×</button></td>`;it.appendChild(tr);});
    const et = document.getElementById("expenseTable"); et.innerHTML="<tr><th>Описание</th><th>Сумма</th><th></th></tr>";
    rawExpenses.forEach((e,idx)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${e.d}</td><td>${fmt(fromRUB(e.a))} ${sym}</td><td><button class="delete-btn" onclick="delExp(${idx})">×</button></td>`;et.appendChild(tr);});

    document.getElementById("statsInfo").innerHTML = `
        Доходы: ${fmt(fromRUB(c.inc))} ${sym}<br>
        Расходы: ${fmt(fromRUB(c.exp))} ${sym}<br>
        Баланс: ${fmt(fromRUB(c.bal))} ${sym}<br>
        <small>Всё хранится в RUB — пересчёт точный</small>
    `;
}

// Действия
function addIncome(){const d=document.getElementById("incomeDesc").value.trim();const a=parseFloat(document.getElementById("incomeAmount").value);if(d&&a>0){rawIncomes.push({d,a:toRUB(a)});save();renderAll();document.getElementById("incomeDesc").value="";document.getElementById("incomeAmount").value="";}}
function addExpense(){const d=document.getElementById("expenseDesc").value.trim();const a=parseFloat(document.getElementById("expenseAmount").value);if(d&&a>0){rawExpenses.push({d,a:toRUB(a)});save();renderAll();document.getElementById("expenseDesc").value="";document.getElementById("expenseAmount").value="";}}
function delInc(i){rawIncomes.splice(i,1);save();renderAll();}
function delExp(i){rawExpenses.splice(i,1);save();renderAll();}
function setGoal(){const n=document.getElementById("goalName").value.trim();const a=parseFloat(document.getElementById("goalAmount").value);if(n&&a>0){rawGoal={n,a:toRUB(a)};save();renderAll();}}
function showPage(id){document.querySelectorAll(".page").forEach(p=>p.style.display="none");document.getElementById(id).style.display="block";if(id==="stats")renderAll();}

renderAll();
</script>
</body>
</html>
